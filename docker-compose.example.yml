name: nfx-stack

services:
  #! MySQL 公共数据库
  mysql:
    image: mysql:8.0
    container_name: NFX-Stack-MySQL
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "${MYSQL_DATABASE_HOST:-0.0.0.0}:${MYSQL_DATABASE_PORT}:3306"
    volumes:
      - ${MYSQL_DATA_PATH:-/home/kali/repo/Databases/mysql}:/var/lib/mysql
      - ${MYSQL_INIT_PATH:-/home/kali/repo/Databases/mysql-init}:/docker-entrypoint-initdb.d
      - ${MYSQL_LOG_PATH:-/home/kali/repo/Logs/mysql}:/var/log/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! phpMyAdmin 管理 MySQL（公共资源）
  mysql-ui:
    image: phpmyadmin:latest
    container_name: NFX-Stack-MySQL-UI
    restart: always
    expose:
      - "80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: "1"
    ports:
      - "${MYSQL_UI_HOST:-0.0.0.0}:${MYSQL_UI_PORT}:80"
    depends_on:
      - mysql
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! MongoDB 公共实例
  mongodb:
    image: mongo:4.4
    container_name: NFX-Stack-MongoDB
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    ports:
      - "${MONGO_DATABASE_HOST:-0.0.0.0}:${MONGO_DATABASE_PORT}:27017"
    volumes:
      - ${MONGO_DATA_PATH:-/home/kali/repo/Databases/mongodb}:/data/db
      - ${MONGO_INIT_PATH:-/home/kali/repo/Databases/mongodb-init}:/docker-entrypoint-initdb.d
      - ${MONGO_LOG_PATH:-/home/kali/repo/Logs/mongodb}:/var/log/mongodb
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! MongoDB UI
  mongodb-ui:
    image: mongo-express:latest
    container_name: NFX-Stack-MongoDB-UI
    restart: always
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD}
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_SITE_BASEURL: /
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_UI_USERNAME}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_UI_PASSWORD}
    ports:
      - "${MONGO_UI_HOST:-0.0.0.0}:${MONGO_UI_PORT}:8081"
    depends_on:
      - mongodb
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! PostgreSQL 公共数据库
  postgresql:
    image: postgres:15-alpine
    container_name: NFX-Stack-PostgreSQL
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRESQL_ROOT_USERNAME}
      POSTGRES_PASSWORD: ${POSTGRESQL_ROOT_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRESQL_DATABASE_HOST:-0.0.0.0}:${POSTGRESQL_DATABASE_PORT}:5432"
    volumes:
      - ${POSTGRESQL_DATA_PATH:-/home/kali/repo/Databases/postgresql}:/var/lib/postgresql/data
      - ${POSTGRESQL_INIT_PATH:-/home/kali/repo/Databases/postgresql-init}:/docker-entrypoint-initdb.d
      - ${POSTGRESQL_LOG_PATH:-/home/kali/repo/Logs/postgresql}:/var/log/postgresql
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! pgAdmin 管理 PostgreSQL（公共资源）
  postgresql-ui:
    image: dpage/pgadmin4:latest
    container_name: NFX-Stack-PostgreSQL-UI
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${POSTGRESQL_UI_USERNAME:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${POSTGRESQL_UI_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "${POSTGRESQL_UI_HOST:-0.0.0.0}:${POSTGRESQL_UI_PORT}:80"
    depends_on:
      - postgresql
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! Redis 公共实例
  redis:
    image: redis:7-alpine
    container_name: NFX-Stack-Redis
    restart: always
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --save "60 1000"
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --protected-mode no
      --requirepass ${REDIS_PASSWORD}
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "${REDIS_DATABASE_HOST:-0.0.0.0}:${REDIS_DATABASE_PORT}:6379"
    volumes:
      - ${REDIS_DATA_PATH:-/home/kali/repo/Databases/redis}:/data
      - ${REDIS_LOG_PATH:-/home/kali/repo/Logs/redis}:/var/log/redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! RedisInsight UI
  redis-ui:
    image: redis/redisinsight:latest
    container_name: NFX-Stack-Redis-UI
    restart: always
    ports:
      - "${REDIS_UI_HOST:-0.0.0.0}:${REDIS_UI_PORT}:5540"
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack


  #! 以下是 kafka 的配置
  kafka:
    image: apache/kafka:latest
    container_name: NFX-Stack-Kafka
    hostname: kafka
    restart: always
    ports:
      - "${KAFKA_EXTERNAL_HOST:-0.0.0.0}:${KAFKA_EXTERNAL_PORT}:9094"   # 例如 192.168.1.64:10109:9094，只给 LAN
    environment:
      KAFKA_NODE_ID: 1 # 节点 ID，KRaft 模式下每个节点需要唯一 ID
      KAFKA_PROCESS_ROLES: broker,controller # 节点角色，这里是单节点，既做 broker（处理消息）又做 controller（集群协调）
      # Kafka 监听的端口与协议：
      # - PLAINTEXT://:9092 提供给 Docker 内部服务访问
      # - CONTROLLER://:9093 提供给控制器使用
      # - EXTERNAL://:9094 提供给宿主机或外部客户端访问
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      # 对客户端声明的可连接地址：
      # - Docker 内部容器用 kafka:9092
      # - 宿主机外部客户端用 host.docker.internal:9094（Linux 请改成实际主机 IP）
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://${KAFKA_INTERNAL_HOST_IP}:${KAFKA_EXTERNAL_PORT}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT # 定义 listener 与协议的映射关系
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT # broker 间通讯使用 PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER # controller 节点监听名，这里就是 CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093 # 定义 controller 投票者集合（nodeId@host:port），这里只有一个节点
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true" # 是否自动创建 topic，开发环境建议开启
      KAFKA_NUM_PARTITIONS: 3 # 默认分区数（topic 没指定分区数时用这个）
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 # offsets 主题（存消费位点）的副本数，这里单节点必须设为 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1 # 事务日志副本数（单节点同样设为 1）
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1 # 事务日志最小 ISR 副本数（单节点同样设为 1）
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0 # 组初始再平衡延迟（0 表示立即）
      # KAFKA_LOG_DIRS: /var/lib/kafka/data # 日志目录
    volumes:
      - ${KAFKA_DATA_PATH:-/home/kali/repo/Databases/kafka}:/var/lib/kafka/data
      # - ${KAFKA_LOG_PATH:-/home/kali/repo/Logs/kafka}:/var/log/kafka
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    networks:
      - nfx-stack

  #! Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: NFX-Stack-Kafka-UI
    restart: always
    depends_on:
      - kafka
    ports:
      - "${KAFKA_UI_HOST:-0.0.0.0}:${KAFKA_UI_PORT}:8080"
    environment:
      SERVER_SERVLET_CONTEXT_PATH: /
      DYNAMIC_CONFIG_ENABLED: "true"
      KAFKA_CLUSTERS_0_NAME: nfx_stack_public
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack

  #! RabbitMQ 消息队列
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: NFX-Stack-RabbitMQ
    hostname: ${RABBITMQ_HOST_NAME:-rabbitmq}
    restart: always
    ports:
      - "${RABBITMQ_HOST:-0.0.0.0}:${RABBITMQ_AMQP_PORT}:5672"     # AMQP 协议端口
      - "${RABBITMQ_HOST:-0.0.0.0}:${RABBITMQ_UI_PORT}:15672"     # Management UI 端口
    environment:
      # ---- Node identity (对标 Kafka node.id) ----
      RABBITMQ_NODENAME: ${RABBITMQ_NODE_NAME}
      RABBITMQ_CLUSTER_NAME: ${RABBITMQ_CLUSTER_NAME}
      # ---- Auth bootstrap ----
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      # ---- Cluster trust (对标 controller quorum) ----
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE}
      # 文件日志（配合 /var/log/rabbitmq 挂载）
      # RABBITMQ_LOGS: /var/log/rabbitmq/rabbitmq.log
      # RABBITMQ_SASL_LOGS: /var/log/rabbitmq/rabbitmq-sasl.log
    volumes:
      # Data persistence
      - ${RABBITMQ_DATA_PATH:-/home/kali/repo/Databases/rabbitmq}:/var/lib/rabbitmq
      # - ${RABBITMQ_LOG_PATH:-/home/kali/repo/Logs/rabbitmq}:/var/log/rabbitmq
    # healthcheck:
    #   test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 12
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    networks:
      - nfx-stack


  # #! MinIO
  # minio:
  #   image: minio/minio:RELEASE.2025-04-22T22-12-26Z
  #   container_name: NFX-Stack-MinIO
  #   restart: always
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_ROOT_USER}
  #     MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
  #     MINIO_API_PATH_STYLE: "on"       # ★★★ 启用 path-style，关键！！
  #     MINIO_BROWSER_REDIRECT_URL: ""   # 防止 UI 跳转奇怪域名（新版本必加）
  #   command: server /data --console-address ":9001"
  #   ports:
  #     - "${MINIO_API_HOST:-0.0.0.0}:${MINIO_API_PORT}:9000"        # S3 API
  #     - "${MINIO_UI_HOST:-0.0.0.0}:${MINIO_UI_PORT}:9001"         # Web Console
  #   volumes:
  #     - ${MINIO_DATA_PATH:-/home/kali/repo//Stores}:/data
  #     - ${MINIO_LOG_PATH:-/home/kali/repo/Logs/minio}:/var/log/minio
  #   networks:
  #     - nfx-stack

networks:
  nfx-stack:
    name: nfx-stack
    driver: bridge